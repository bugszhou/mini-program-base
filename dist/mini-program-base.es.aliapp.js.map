{"version":3,"file":"mini-program-base.es.aliapp.js","sources":["../src/ComponentBase.aliapp.ts","../src/observer.ts","../src/Decorators/Page.aliapp.ts","../src/Decorators/Component.aliapp.ts"],"sourcesContent":["import {\n  MiniComponent,\n  method,\n  ComponentBase as MiniComponentBase,\n} from \"mipp-ali\";\n\nexport default class ComponentBase<\n  IData = any,\n> extends MiniComponentBase<IData> {\n  @method\n  aom<IComponent = MiniComponent<any>>(): IComponent {\n    return this as unknown as IComponent;\n  }\n}\n\nexport { MiniComponent };\n","import get from \"lodash.get\";\nimport isEqual from \"lodash.isequal\";\n\nexport enum OBSERVER_TYPE {\n  DATA = \"data\",\n  PROPS = \"props\",\n  ALL = \"all\",\n  UNKNOWN = \"unknown\",\n}\n\nexport interface ObserverParams {\n  /**\n   * 组件的上下文\n   */\n  context: any;\n  /**\n   * 监听函数的数组\n   */\n  subscribeMap: Record<string, any[]>;\n  /**\n   * 是否强制触发所有监听\n   */\n  forceEmit?: boolean;\n  /**\n   * 上一个Props的状态\n   */\n  prevProps?: any;\n  /**\n   * 上一个Data的状态\n   */\n  prevData?: any;\n}\n\ninterface ObserverItem {\n  value: any;\n  changed: boolean;\n  type: OBSERVER_TYPE;\n}\n\n/**\n * 监听Props的变化, for 监听函数\n * 参考微信文档进行实现：\n * https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/observer.html\n * 为明确触发的字段来自props还是data，监听函数的入参除了依顺序提供监听字段的当前值，也会依顺序提供监听字段可能的参考来源\n * 具体类型可参考OBSERVER_TYPE\n */\nexport default function observer(key?: string) {\n  return function closureFn(\n    target: any,\n    property: string,\n    descriptor: PropertyDescriptor,\n  ) {\n    const fn = descriptor.value;\n    const subscribeKey = key || property;\n\n    if (!target._propsSubscribeMap) {\n      target._propsSubscribeMap = {};\n      // didMount 监听\n      const mountPublisher = target.didMount;\n      target.didMount = async function newDidMount(...mountArgs: any[]) {\n        try {\n          const subscribeMap = target._propsSubscribeMap || {};\n          checkSubscribe({\n            context: this,\n            subscribeMap,\n            forceEmit: true,\n          });\n          if (typeof mountPublisher === \"function\") {\n            const result = await mountPublisher.call(this, ...mountArgs);\n            return result;\n          }\n        } catch (e) {\n          throw e;\n        }\n      };\n      // didUpdate 监听\n      const updatePublisher = target.didUpdate;\n      target.didUpdate = async function newDidUpdate(\n        prevProps: any,\n        prevData: any,\n      ) {\n        try {\n          const subscribeMap = target._propsSubscribeMap || {};\n          checkSubscribe({\n            context: this,\n            subscribeMap,\n            forceEmit: false,\n            prevProps,\n            prevData,\n          });\n          if (typeof updatePublisher === \"function\") {\n            const result = await updatePublisher.call(\n              this,\n              prevProps,\n              prevData,\n            );\n            return result;\n          }\n        } catch (e) {\n          throw e;\n        }\n      };\n    }\n    if (!target._propsSubscribeMap[subscribeKey]) {\n      target._propsSubscribeMap[subscribeKey] = [];\n    }\n    target._propsSubscribeMap[subscribeKey].push(fn);\n  };\n}\n\nfunction checkSubscribe({\n  context,\n  subscribeMap,\n  forceEmit = false,\n  prevProps = {},\n  prevData = {},\n}: ObserverParams) {\n  Object.keys(subscribeMap).forEach((mapKey) => {\n    const observerKeys = mapKey\n      ?.split(\",\")\n      .map((key) => key?.replace(\".**\", \"\").trim());\n    const fnParams = observerKeys?.map((key): ObserverItem => {\n      if (!key) {\n        return {\n          value: undefined,\n          changed: false,\n          type: OBSERVER_TYPE.UNKNOWN,\n        };\n      }\n      // 通配符触发所有监听\n      if (key === \"**\") {\n        return {\n          value: undefined,\n          changed: true,\n          type: OBSERVER_TYPE.ALL,\n        };\n      }\n\n      const prevPropsValue = get(prevProps, key);\n      const propsValue = get(context?.props, key);\n      const prevDataValue = get(prevData, key);\n      const dataValue = get(context?.data, key);\n\n      // 优先检查props变化\n      if (!isEqual(prevPropsValue, propsValue)) {\n        return {\n          value: propsValue,\n          changed: true,\n          type: OBSERVER_TYPE.PROPS,\n        };\n      }\n\n      // 检查data变化\n      if (!isEqual(prevDataValue, dataValue)) {\n        return {\n          value: dataValue,\n          changed: true,\n          type: OBSERVER_TYPE.DATA,\n        };\n      }\n\n      // 处理不变化时的数据讨论\n      let type = OBSERVER_TYPE.UNKNOWN;\n      let value = undefined;\n      if (typeof propsValue !== \"undefined\") {\n        type = OBSERVER_TYPE.PROPS;\n        value = propsValue;\n      } else if (typeof dataValue !== \"undefined\") {\n        type = OBSERVER_TYPE.DATA;\n        value = dataValue;\n      }\n\n      return {\n        value,\n        changed: false,\n        type,\n      };\n    });\n    if (!forceEmit && fnParams.every((params) => !params?.changed)) return;\n    subscribeMap[mapKey]?.forEach((fn) => {\n      fn?.call?.(\n        context,\n        ...fnParams.map((param) => param?.value),\n        ...fnParams.map((param) => param?.type),\n      );\n    });\n  });\n}\n","import { MiniPage } from \"mipp-ali\";\n\nexport default function MiniProgramPage(target: new (...opts: any[]) => any) {\n  const obj = new target();\n  MiniPage.render(obj);\n}\n","import { ComponentBase } from \"mipp-ali\";\n\nexport default function MiniProgramComponent(\n  target: new (...opts: any[]) => any,\n) {\n  const obj = new target();\n  ComponentBase.render(obj);\n}\n"],"names":["MiniComponentBase","ComponentBase"],"mappings":"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"}