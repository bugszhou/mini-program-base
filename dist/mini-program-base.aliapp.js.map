{"version":3,"file":"mini-program-base.aliapp.js","sources":["../src/ComponentBase.aliapp.ts","../src/observer.ts","../src/index.aliapp.ts","../src/Decorators/Component.aliapp.ts","../src/Decorators/Page.aliapp.ts","../src/helps/index.ts"],"sourcesContent":["import {\n  MiniComponent,\n  method,\n  ComponentBase as MiniComponentBase,\n  lifetime,\n} from \"mipp-ali\";\nimport { IEventBase } from \"./Decorators/events\";\n\nexport default class ComponentBase<\n  IData = any,\n> extends MiniComponentBase<IData> {\n  viewStatus: \"load\" | \"show\" | \"ready\" = \"load\";\n\n  @method\n  aom<IComponent = MiniComponent<any>>(): IComponent {\n    return this as unknown as IComponent;\n  }\n\n  @lifetime\n  created(...opts: any) {\n    try {\n      this.viewStatus = \"load\";\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n      // @ts-ignore\n      super.created?.(...opts);\n    } catch {}\n  }\n\n  @lifetime\n  show(...opts: any) {\n    try {\n      if (this.viewStatus !== \"ready\") {\n        this.viewStatus = \"show\";\n      }\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n      // @ts-ignore\n      super.show?.(...opts);\n    } catch {}\n  }\n\n  @lifetime\n  ready(...opts: any) {\n    try {\n      this.viewStatus = \"ready\";\n      // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n      // @ts-ignore\n      super.ready?.(...opts);\n    } catch {}\n  }\n\n  /**\n   * 视图是否准备完成\n   * @returns boolean\n   */\n  @method\n  isReady() {\n    return this?.viewStatus === \"ready\";\n  }\n\n  @method\n  getEvents<IEvent = IEventBase>(): IEvent {\n    throw new TypeError(\"需要在子类重写: getEvents 方法\");\n  }\n}\n\nexport { MiniComponent };\n","import get from \"lodash.get\";\nimport isEqual from \"lodash.isequal\";\n\nexport enum OBSERVER_TYPE {\n  DATA = \"data\",\n  PROPS = \"props\",\n  ALL = \"all\",\n  UNKNOWN = \"unknown\",\n}\n\nexport interface ObserverParams {\n  /**\n   * 组件的上下文\n   */\n  context: any;\n  /**\n   * 监听函数的数组\n   */\n  subscribeMap: Record<string, any[]>;\n  /**\n   * 是否强制触发所有监听\n   */\n  forceEmit?: boolean;\n  /**\n   * 上一个Props的状态\n   */\n  prevProps?: any;\n  /**\n   * 上一个Data的状态\n   */\n  prevData?: any;\n}\n\ninterface ObserverItem {\n  value: any;\n  changed: boolean;\n  type: OBSERVER_TYPE;\n}\n\n/**\n * 监听Props的变化, for 监听函数\n * 参考微信文档进行实现：\n * https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/observer.html\n * 为明确触发的字段来自props还是data，监听函数的入参除了依顺序提供监听字段的当前值，也会依顺序提供监听字段可能的参考来源\n * 具体类型可参考OBSERVER_TYPE\n */\nexport default function observer(key?: string) {\n  return function closureFn(\n    target: any,\n    property: string,\n    descriptor: PropertyDescriptor,\n  ) {\n    const fn = descriptor.value;\n    const subscribeKey = key || property;\n\n    if (!target._propsSubscribeMap) {\n      target._propsSubscribeMap = {};\n      // didMount 监听\n      const mountPublisher = target.didMount;\n      target.didMount = async function newDidMount(...mountArgs: any[]) {\n        try {\n          const subscribeMap = target._propsSubscribeMap || {};\n          checkSubscribe({\n            context: this,\n            subscribeMap,\n            forceEmit: true,\n          });\n          if (typeof mountPublisher === \"function\") {\n            const result = await mountPublisher.call(this, ...mountArgs);\n            return result;\n          }\n        } catch (e) {\n          throw e;\n        }\n      };\n      // didUpdate 监听\n      const updatePublisher = target.didUpdate;\n      target.didUpdate = async function newDidUpdate(\n        prevProps: any,\n        prevData: any,\n      ) {\n        try {\n          const subscribeMap = target._propsSubscribeMap || {};\n          checkSubscribe({\n            context: this,\n            subscribeMap,\n            forceEmit: false,\n            prevProps,\n            prevData,\n          });\n          if (typeof updatePublisher === \"function\") {\n            const result = await updatePublisher.call(\n              this,\n              prevProps,\n              prevData,\n            );\n            return result;\n          }\n        } catch (e) {\n          throw e;\n        }\n      };\n    }\n    if (!target._propsSubscribeMap[subscribeKey]) {\n      target._propsSubscribeMap[subscribeKey] = [];\n    }\n    target._propsSubscribeMap[subscribeKey].push(fn);\n  };\n}\n\nfunction checkSubscribe({\n  context,\n  subscribeMap,\n  forceEmit = false,\n  prevProps = {},\n  prevData = {},\n}: ObserverParams) {\n  Object.keys(subscribeMap).forEach((mapKey) => {\n    const observerKeys = mapKey\n      ?.split(\",\")\n      .map((key) => key?.replace(\".**\", \"\").trim());\n    const fnParams = observerKeys?.map((key): ObserverItem => {\n      if (!key) {\n        return {\n          value: undefined,\n          changed: false,\n          type: OBSERVER_TYPE.UNKNOWN,\n        };\n      }\n      // 通配符触发所有监听\n      if (key === \"**\") {\n        return {\n          value: undefined,\n          changed: true,\n          type: OBSERVER_TYPE.ALL,\n        };\n      }\n\n      const prevPropsValue = get(prevProps, key);\n      const propsValue = get(context?.props, key);\n      const prevDataValue = get(prevData, key);\n      const dataValue = get(context?.data, key);\n\n      // 优先检查props变化\n      if (!isEqual(prevPropsValue, propsValue)) {\n        return {\n          value: propsValue,\n          changed: true,\n          type: OBSERVER_TYPE.PROPS,\n        };\n      }\n\n      // 检查data变化\n      if (!isEqual(prevDataValue, dataValue)) {\n        return {\n          value: dataValue,\n          changed: true,\n          type: OBSERVER_TYPE.DATA,\n        };\n      }\n\n      // 处理不变化时的数据讨论\n      let type = OBSERVER_TYPE.UNKNOWN;\n      let value = undefined;\n      if (typeof propsValue !== \"undefined\") {\n        type = OBSERVER_TYPE.PROPS;\n        value = propsValue;\n      } else if (typeof dataValue !== \"undefined\") {\n        type = OBSERVER_TYPE.DATA;\n        value = dataValue;\n      }\n\n      return {\n        value,\n        changed: false,\n        type,\n      };\n    });\n    if (!forceEmit && fnParams.every((params) => !params?.changed)) return;\n    subscribeMap[mapKey]?.forEach((fn) => {\n      fn?.call?.(\n        context,\n        ...fnParams.map((param) => param?.value),\n        ...fnParams.map((param) => param?.type),\n      );\n    });\n  });\n}\n","import {\n  MiniComponent as WeappMiniComponent,\n  IMiniComponentOptions,\n  PageBase as WeappPageBase,\n} from \"mipp\";\nimport {\n  MiniComponent as AliMiniComponent,\n  method,\n  IComponentData,\n  pageLifetime,\n  lifetimes,\n  IMiniEvent,\n  MiniPage as PageBase,\n} from \"mipp-ali\";\nimport ComponentBase from \"./ComponentBase.aliapp\";\nimport observer from \"./observer\";\nimport { IEventBase } from \"./Decorators/events\";\nexport * from \"./Decorators/index.aliapp\";\n\nclass ViewBase<IData extends Record<string, any>> extends PageBase<IData> {\n  viewStatus: \"load\" | \"show\" | \"ready\" = \"load\";\n\n  onLoad(...opts: any) {\n    try {\n      this.viewStatus = \"load\";\n      if (typeof super.onLoad === \"function\") {\n        // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n        // @ts-ignore\n        super.onLoad(...opts);\n      }\n    } catch {}\n  }\n\n  onShow(...opts: any) {\n    try {\n      if (this.viewStatus !== \"ready\") {\n        this.viewStatus = \"show\";\n      }\n      if (typeof super.onShow === \"function\") {\n        // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n        // @ts-ignore\n        super.onShow(...opts);\n      }\n    } catch {}\n  }\n\n  onReady(...opts: any) {\n    try {\n      this.viewStatus = \"ready\";\n      if (typeof super.onReady === \"function\") {\n        // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n        // @ts-ignore\n        super.onReady(...opts);\n      }\n    } catch {}\n  }\n\n  /**\n   * 视图是否准备完成\n   * @returns boolean\n   */\n  isReady() {\n    return this?.viewStatus === \"ready\";\n  }\n\n  getEvents<IEvent = IEventBase>(): IEvent {\n    throw new TypeError(\"需要在子类重写: getEvents 方法\");\n  }\n}\n\nexport {\n  ComponentBase,\n  AliMiniComponent as MiniComponent,\n  WeappMiniComponent,\n  AliMiniComponent,\n  IComponentData,\n  observer,\n  method,\n  pageLifetime,\n  lifetimes,\n  IMiniEvent,\n  IMiniComponentOptions,\n  ViewBase as PageBase,\n  ViewBase as AliappPageBase,\n  WeappPageBase,\n};\n","import { ComponentBase } from \"mipp-ali\";\n\nexport default function MiniProgramComponent(\n  target: new (...opts: any[]) => any,\n) {\n  const obj = new target();\n  ComponentBase.render(obj);\n}\n","import { MiniPage } from \"mipp-ali\";\nimport { generateRandomString } from \"../helps\";\n\nexport default function MiniProgramPage(target: new (...opts: any[]) => any) {\n  const obj = new target();\n  obj.__serialNumber = generateRandomString();\n  MiniPage.render(obj);\n}\n","export function generateRandomString() {\n  return Date.now().toString(32) + Math.random().toString(32).substring(2);\n}\n"],"names":["OBSERVER_TYPE","ComponentBase","_super","_this","apply","this","arguments","viewStatus","__extends","prototype","aom","created","opts","_i","length","_a","call","__spreadArray","_b","show","ready","isReady","getEvents","TypeError","__decorate","method","__metadata","IComponent","Object","lifetime","IEvent","MiniComponentBase","checkSubscribe","context","subscribeMap","forceEmit","_c","prevProps","_d","prevData","keys","forEach","mapKey","observerKeys","split","map","key","replace","trim","fnParams","value","undefined","changed","type","UNKNOWN","ALL","prevPropsValue","get","propsValue","props","prevDataValue","dataValue","data","isEqual","PROPS","DATA","every","params","fn","param","ViewBase","onLoad","onShow","onReady","PageBase","defineProperty","exports","enumerable","mipp","MiniComponent","mippAli","lifetimes","pageLifetime","AliappPageBase","MiniProgramComponent","target","obj","render","MiniProgramPage","__serialNumber","Date","now","toString","Math","random","substring","MiniPage","observer","property","descriptor","subscribeKey","_propsSubscribeMap","mountPublisher_1","didMount","mountArgs","sent","updatePublisher_1","didUpdate","push"],"mappings":"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"}